"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var sqlite = require("nativescript-sqlite");
var visit_1 = require("./visit");
var VisitDatabaseService = (function () {
    function VisitDatabaseService() {
        console.log("In Visit DB Service Constructor");
    }
    // create a table
    VisitDatabaseService.prototype.createTable = function () {
        new sqlite("visit.db", function (err, db) {
            db.execSQL("CREATE TABLE IF NOT EXISTS Visit (id INTEGER PRIMARY KEY, customer_id TEXT, beacon TEXT, start DATETIME,end DATETIME,creating NUMERIC, active NUMERIC, keywords JSON )", [], function (err) {
                console.log("TABLE Visit CREATED");
                return true;
            });
        });
    };
    // drops a table
    VisitDatabaseService.prototype.dropTable = function () {
        new sqlite("visit.db", function (err, db) {
            db.execSQL("DROP TABLE IF EXISTS Visit", [], function (err) {
                console.log("TABLE Visit DROPPED");
                return true;
            });
        });
    };
    VisitDatabaseService.prototype.insertVisit = function (visit) {
        if (visit.id == null) {
            visit.id = visit.beacon;
        }
        console.log("Attempting to insert visit: " + visit.id);
        new sqlite("visit.db", function (err, db) {
            db.execSQL("INSERT INTO Visit (id, customer_id,  beacon , start ,end ,creating , active , keywords ) VALUES (?,?,?,?,?,?,?,?)", [visit.id, visit.customer_id, visit.beacon, visit.start, visit.end, visit.creating, visit.active, visit.keywords], function (err, id) {
                console.log("The new visit record with id " + id + " and beacon " + visit.beacon);
                return true;
            });
        });
    };
    // update an existing record
    //   updateVisit(id,customer_id,  beacon , start ,end ,creating , active , keywords) {
    VisitDatabaseService.prototype.updateVisit = function (visit) {
        new sqlite("visit.db", function (err, db) {
            // db.execSQL("UPDATE Visit SET customer_id = ?, beacon = ?, start = ?, end = ?, creating = ?, active = ?, keywords = ? WHERE id = ?", [customer_id, beacon, start, end, creating, active, keywords, id], function(err, id) {
            db.execSQL("UPDATE Visit SET customer_id = ?, beacon = ?, start = ?, end = ?, creating = ?, active = ?, keywords = ? WHERE id = ?", [visit.customer_id, visit.beacon, visit.start, new Date(), visit.creating, visit.active, visit.keywords, visit.id], function (err, id) {
                console.log("The existing visit record id is: " + id);
                return true;
            });
        });
    };
    // delete a record
    VisitDatabaseService.prototype.deleteVisit = function (id) {
        console.log("About to delete visit from db: " + id);
        new sqlite("visit.db", function (err, db) {
            db.execSQL("DELETE FROM Visit WHERE id = ?", [id], function (err, id) {
                console.log("The deleted visit record id is: " + id);
                return true;
            });
        });
    };
    // select a single record
    VisitDatabaseService.prototype.selectVisit = function (id) {
        var record;
        new sqlite("visit.db", function (err, db) {
            db.get("SELECT * FROM Visit WHERE id = ?", [id], function (err, row) {
                // console.log("Row of data was: " + row);  // Prints [["Field1", "Field2",...]] 
                // console.log("1: "+row[1]);
                record = new visit_1.Visit(row[1], row[2], row[3], row[4]);
                record.id = row[0];
                // record = row;
                // return row;
            });
        });
        return record;
    };
    // select a single record
    VisitDatabaseService.prototype.selectVisitByBeacon = function (beacon) {
        console.log("select beacon: " + beacon);
        var record = null;
        new sqlite("visit.db", function (err, db) {
            db.get("SELECT * FROM Visit WHERE beacon = ? LIMIT 1", [beacon], function (err, row) {
                if (row != null) {
                    console.log("Row of visit data was: " + row); // Prints [["Field1", "Field2",...]] 
                    // console.log("1: "+row[1]);
                    record = new visit_1.Visit(row[1], row[2], row[3], row[4]);
                    record.id = row[0];
                    // record = row;
                    // return row;
                }
                else {
                    record = null;
                }
            });
        });
        console.log("record (visit):" + record);
        return record;
    };
    // select all records
    VisitDatabaseService.prototype.selectVisits = function () {
        var visits = new Array();
        new sqlite("visit.db", function (err, db) {
            db.all("SELECT * FROM Visit ORDER BY id", [], function (err, rs) {
                rs.forEach(function (element) {
                    // console.log("E0: "+element[0]);
                    // console.log("E1: "+element[1]);
                    // console.log("E2: "+element[2]);
                    // console.log("E3: "+element[3]);
                    // console.log("E4: "+element[4]);
                    // console.log("E5: "+element[5]);
                    // console.log("E6: "+element[6]);
                    // console.log("E7: "+element[7]);
                    var visitObj = new visit_1.Visit(element[1], element[2], element[3], element[4]);
                    visitObj.id = element[0];
                    visitObj.creating = element[5];
                    visitObj.active = element[6];
                    visitObj.keywords = element[7];
                    visits.push(visitObj);
                });
            });
        });
        return visits;
    };
    VisitDatabaseService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], VisitDatabaseService);
    return VisitDatabaseService;
}());
exports.VisitDatabaseService = VisitDatabaseService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzaXQuZGIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZpc2l0LmRiLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBeUQ7QUFDekQsSUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFFLHFCQUFxQixDQUFFLENBQUM7QUFDaEQsaUNBQWdDO0FBR2hDO0lBRUU7UUFDSSxPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELGlCQUFpQjtJQUNqQiwwQ0FBVyxHQUFYO1FBQ0UsSUFBSSxNQUFNLENBQUMsVUFBVSxFQUFFLFVBQVMsR0FBRyxFQUFFLEVBQUU7WUFDbkMsRUFBRSxDQUFDLE9BQU8sQ0FBQyx3S0FBd0ssRUFBRSxFQUFFLEVBQUUsVUFBUyxHQUFHO2dCQUNqTSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUM7Z0JBQ25DLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxnQkFBZ0I7SUFDaEIsd0NBQVMsR0FBVDtRQUNFLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRSxVQUFTLEdBQUcsRUFBRSxFQUFFO1lBQ25DLEVBQUUsQ0FBQyxPQUFPLENBQUMsNEJBQTRCLEVBQUUsRUFBRSxFQUFFLFVBQVMsR0FBRztnQkFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2dCQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsMENBQVcsR0FBWCxVQUFZLEtBQVk7UUFDcEIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsQ0FBQSxDQUFDO1lBQ2xCLEtBQUssQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLE1BQU0s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IHsgSW5qZWN0YWJsZSwgRXZlbnRFbWl0dGVyIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmNvbnN0IHNxbGl0ZSA9IHJlcXVpcmUoIFwibmF0aXZlc2NyaXB0LXNxbGl0ZVwiICk7XG5pbXBvcnQgeyBWaXNpdCB9IGZyb20gXCIuL3Zpc2l0XCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBWaXNpdERhdGFiYXNlU2VydmljZSB7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xuICAgICAgY29uc29sZS5sb2coXCJJbiBWaXNpdCBEQiBTZXJ2aWNlIENvbnN0cnVjdG9yXCIpO1xuICB9XG5cbiAgLy8gY3JlYXRlIGEgdGFibGVcbiAgY3JlYXRlVGFibGUoKSB7XG4gICAgbmV3IHNxbGl0ZShcInZpc2l0LmRiXCIsIGZ1bmN0aW9uKGVyciwgZGIpIHtcbiAgICAgICAgZGIuZXhlY1NRTChcIkNSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIFZpc2l0IChpZCBJTlRFR0VSIFBSSU1BUlkgS0VZLCBjdXN0b21lcl9pZCBURVhULCBiZWFjb24gVEVYVCwgc3RhcnQgREFURVRJTUUsZW5kIERBVEVUSU1FLGNyZWF0aW5nIE5VTUVSSUMsIGFjdGl2ZSBOVU1FUklDLCBrZXl3b3JkcyBKU09OIClcIiwgW10sIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUQUJMRSBWaXNpdCBDUkVBVEVEXCIpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIFxuICAvLyBkcm9wcyBhIHRhYmxlXG4gIGRyb3BUYWJsZSgpIHtcbiAgICBuZXcgc3FsaXRlKFwidmlzaXQuZGJcIiwgZnVuY3Rpb24oZXJyLCBkYikge1xuICAgICAgICBkYi5leGVjU1FMKFwiRFJPUCBUQUJMRSBJRiBFWElTVFMgVmlzaXRcIiwgW10sIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUQUJMRSBWaXNpdCBEUk9QUEVEXCIpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIFxuICBpbnNlcnRWaXNpdCh2aXNpdDogVmlzaXQpIHtcbiAgICAgIGlmICh2aXNpdC5pZCA9PSBudWxsKXtcbiAgICAgICAgICB2aXNpdC5pZCA9IHZpc2l0LmJlYWNvbjtcbiAgICAgIH1cbiAgICBjb25zb2xlLmxvZyhcIkF0dGVtcHRpbmcgdG8gaW5zZXJ0IHZpc2l0OiBcIit2aXNpdC5pZCk7XG4gICAgbmV3IHNxbGl0ZShcInZpc2l0LmRiXCIsIGZ1bmN0aW9uKGVyciwgZGIpIHtcbiAgICAgICAgZGIuZXhlY1NRTChcIklOU0VSVCBJTlRPIFZpc2l0IChpZCwgY3VzdG9tZXJfaWQsICBiZWFjb24gLCBzdGFydCAsZW5kICxjcmVhdGluZyAsIGFjdGl2ZSAsIGtleXdvcmRzICkgVkFMVUVTICg/LD8sPyw/LD8sPyw/LD8pXCIsIFt2aXNpdC5pZCx2aXNpdC5jdXN0b21lcl9pZCwgdmlzaXQuYmVhY29uLCB2aXNpdC5zdGFydCwgdmlzaXQuZW5kLCB2aXNpdC5jcmVhdGluZywgdmlzaXQuYWN0aXZlLCB2aXNpdC5rZXl3b3Jkc10sIGZ1bmN0aW9uKGVyciwgaWQpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVGhlIG5ldyB2aXNpdCByZWNvcmQgd2l0aCBpZCBcIiArIGlkK1wiIGFuZCBiZWFjb24gXCIrdmlzaXQuYmVhY29uKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBcbiAgLy8gdXBkYXRlIGFuIGV4aXN0aW5nIHJlY29yZFxuLy8gICB1cGRhdGVWaXNpdChpZCxjdXN0b21lcl9pZCwgIGJlYWNvbiAsIHN0YXJ0ICxlbmQgLGNyZWF0aW5nICwgYWN0aXZlICwga2V5d29yZHMpIHtcbiAgdXBkYXRlVmlzaXQodmlzaXQ6VmlzaXQpIHtcbiAgICBuZXcgc3FsaXRlKFwidmlzaXQuZGJcIiwgZnVuY3Rpb24oZXJyLCBkYikge1xuICAgICAgICAvLyBkYi5leGVjU1FMKFwiVVBEQVRFIFZpc2l0IFNFVCBjdXN0b21lcl9pZCA9ID8sIGJlYWNvbiA9ID8sIHN0YXJ0ID0gPywgZW5kID0gPywgY3JlYXRpbmcgPSA/LCBhY3RpdmUgPSA/LCBrZXl3b3JkcyA9ID8gV0hFUkUgaWQgPSA/XCIsIFtjdXN0b21lcl9pZCwgYmVhY29uLCBzdGFydCwgZW5kLCBjcmVhdGluZywgYWN0aXZlLCBrZXl3b3JkcywgaWRdLCBmdW5jdGlvbihlcnIsIGlkKSB7XG4gICAgICAgIGRiLmV4ZWNTUUwoXCJVUERBVEUgVmlzaXQgU0VUIGN1c3RvbWVyX2lkID0gPywgYmVhY29uID0gPywgc3RhcnQgPSA/LCBlbmQgPSA/LCBjcmVhdGluZyA9ID8sIGFjdGl2ZSA9ID8sIGtleXdvcmRzID0gPyBXSEVSRSBpZCA9ID9cIiwgW3Zpc2l0LmN1c3RvbWVyX2lkLCB2aXNpdC5iZWFjb24sIHZpc2l0LnN0YXJ0LCBuZXcgRGF0ZSgpLCB2aXNpdC5jcmVhdGluZywgdmlzaXQuYWN0aXZlLCB2aXNpdC5rZXl3b3JkcywgdmlzaXQuaWRdLCBmdW5jdGlvbihlcnIsIGlkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRoZSBleGlzdGluZyB2aXNpdCByZWNvcmQgaWQgaXM6IFwiICsgaWQpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIFxuICAvLyBkZWxldGUgYSByZWNvcmRcbiAgZGVsZXRlVmlzaXQoaWQpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiQWJvdXQgdG8gZGVsZXRlIHZpc2l0IGZyb20gZGI6IFwiK2lkKVxuICAgIG5ldyBzcWxpdGUoXCJ2aXNpdC5kYlwiLCBmdW5jdGlvbihlcnIsIGRiKSB7XG4gICAgICAgIGRiLmV4ZWNTUUwoXCJERUxFVEUgRlJPTSBWaXNpdCBXSEVSRSBpZCA9ID9cIiwgW2lkXSwgZnVuY3Rpb24oZXJyLCBpZCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUaGUgZGVsZXRlZCB2aXNpdCByZWNvcmQgaWQgaXM6IFwiICsgaWQpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIFxuICAvLyBzZWxlY3QgYSBzaW5nbGUgcmVjb3JkXG4gIHNlbGVjdFZpc2l0KGlkKTogVmlzaXQge1xuICAgIGxldCByZWNvcmQ6IFZpc2l0O1xuICAgIG5ldyBzcWxpdGUoXCJ2aXNpdC5kYlwiLCBmdW5jdGlvbihlcnIsIGRiKSB7XG4gICAgICAgIGRiLmdldChcIlNFTEVDVCAqIEZST00gVmlzaXQgV0hFUkUgaWQgPSA/XCIsIFtpZF0sIGZ1bmN0aW9uKGVyciwgcm93KSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIlJvdyBvZiBkYXRhIHdhczogXCIgKyByb3cpOyAgLy8gUHJpbnRzIFtbXCJGaWVsZDFcIiwgXCJGaWVsZDJcIiwuLi5dXSBcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiMTogXCIrcm93WzFdKTtcbiAgICAgICAgICAgIHJlY29yZCA9IG5ldyBWaXNpdChyb3dbMV0scm93WzJdLHJvd1szXSxyb3dbNF0pO1xuICAgICAgICAgICAgcmVjb3JkLmlkID0gcm93WzBdO1xuICAgICAgICAgICAgLy8gcmVjb3JkID0gcm93O1xuICAgICAgICAgICAgLy8gcmV0dXJuIHJvdztcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlY29yZDtcbiAgfVxuXG4gICAgLy8gc2VsZWN0IGEgc2luZ2xlIHJlY29yZFxuICAgIHNlbGVjdFZpc2l0QnlCZWFjb24oYmVhY29uKTogVmlzaXQge1xuICAgICAgICBjb25zb2xlLmxvZyhcInNlbGVjdCBiZWFjb246IFwiK2JlYWNvbik7XG4gICAgICAgIGxldCByZWNvcmQ6IFZpc2l0ID0gbnVsbDtcbiAgICAgICAgbmV3IHNxbGl0ZShcInZpc2l0LmRiXCIsIGZ1bmN0aW9uKGVyciwgZGIpIHtcbiAgICAgICAgICAgIGRiLmdldChcIlNFTEVDVCAqIEZST00gVmlzaXQgV0hFUkUgYmVhY29uID0gPyBMSU1JVCAxXCIsIFtiZWFjb25dLCBmdW5jdGlvbihlcnIsIHJvdykge1xuICAgICAgICAgICAgICAgIGlmIChyb3chPW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJvdyBvZiB2aXNpdCBkYXRhIHdhczogXCIgKyByb3cpOyAgLy8gUHJpbnRzIFtbXCJGaWVsZDFcIiwgXCJGaWVsZDJcIiwuLi5dXSBcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCIxOiBcIityb3dbMV0pO1xuICAgICAgICAgICAgICAgICAgICByZWNvcmQgPSBuZXcgVmlzaXQocm93WzFdLHJvd1syXSxyb3dbM10scm93WzRdKTtcbiAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmlkID0gcm93WzBdO1xuICAgICAgICAgICAgICAgICAgICAvLyByZWNvcmQgPSByb3c7XG4gICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiByb3c7XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zb2xlLmxvZyhcInJlY29yZCAodmlzaXQpOlwiICtyZWNvcmQpO1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgICAgfVxuICBcbiAgLy8gc2VsZWN0IGFsbCByZWNvcmRzXG4gIHNlbGVjdFZpc2l0cygpOiBBcnJheTxWaXNpdD4ge1xuICAgIGxldCB2aXNpdHMgPSBuZXcgQXJyYXk8VmlzaXQ+KCk7XG4gICAgbmV3IHNxbGl0ZShcInZpc2l0LmRiXCIsIGZ1bmN0aW9uKGVyciwgZGIpIHtcbiAgICAgICAgZGIuYWxsKFwiU0VMRUNUICogRlJPTSBWaXNpdCBPUkRFUiBCWSBpZFwiLCBbXSwgZnVuY3Rpb24oZXJyLCBycykge1xuICAgICAgICAgIHJzLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkUwOiBcIitlbGVtZW50WzBdKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiRTE6IFwiK2VsZW1lbnRbMV0pO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJFMjogXCIrZWxlbWVudFsyXSk7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkUzOiBcIitlbGVtZW50WzNdKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiRTQ6IFwiK2VsZW1lbnRbNF0pO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJFNTogXCIrZWxlbWVudFs1XSk7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkU2OiBcIitlbGVtZW50WzZdKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiRTc6IFwiK2VsZW1lbnRbN10pO1xuICAgICAgICAgICAgbGV0IHZpc2l0T2JqID0gbmV3IFZpc2l0KGVsZW1lbnRbMV0sIGVsZW1lbnRbMl0sIGVsZW1lbnRbM10sIGVsZW1lbnRbNF0pO1xuICAgICAgICAgICAgdmlzaXRPYmouaWQgPSBlbGVtZW50WzBdO1xuICAgICAgICAgICAgdmlzaXRPYmouY3JlYXRpbmcgPSBlbGVtZW50WzVdO1xuICAgICAgICAgICAgdmlzaXRPYmouYWN0aXZlID0gZWxlbWVudFs2XTtcbiAgICAgICAgICAgIHZpc2l0T2JqLmtleXdvcmRzID0gZWxlbWVudFs3XTtcbiAgICAgICAgICAgIHZpc2l0cy5wdXNoKHZpc2l0T2JqKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgIH0pOyAgIFxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gdmlzaXRzO1xuICB9ICAgXG5cbi8vICAgZmluaXNoVmlzaXRzKCl7XG4vLyAgICAgbGV0IHJlcGx5ID0gZmFsc2Vcbi8vICAgICAgIC8vIFJldHJpdmUgYWxsIHZpc2l0cyAoc2hvdWxkIGJlIG1heCAxKVxuLy8gICAgICAgbGV0IHZpc2l0cyA9IHRoaXMuc2VsZWN0VmlzaXRzKCk7XG5cbi8vICAgICAgIGNvbnNvbGUubG9nKFwiaG93IG1hbnkgaW50ZXJzdHMgdG8gZmluaXNoOiBcIit2aXNpdHMubGVuZ3RoKTtcbi8vICAgICAgIC8vIGlmIHRoZXJlIGlzIGFuIHZpc2l0IFxuLy8gICAgICAgaWYgKHZpc2l0cy5sZW5ndGggPiAwKXtcbi8vICAgICAgICAgICB2aXNpdHMuZm9yRWFjaCh2aXNpdCA9Pntcbi8vICAgICAgICAgICBsZXQgc3RhcnQgPSBuZXcgRGF0ZSh2aXNpdFszXSk7XG4vLyAgICAgICAgICAgbGV0IGVuZCA9IG5ldyBEYXRlKHZpc2l0WzRdKTtcbi8vICAgICAgICAgICBsZXQgZHVyYXRpb24gPSBlbmQuZ2V0VGltZSgpIC0gc3RhcnQuZ2V0VGltZSgpO1xuLy8gICAgICAgICAgIGxldCBzaW5jZUxhc3QgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIGVuZC5nZXRUaW1lKCk7XG4vLyAgICAgICAgICAgLy8gaWYgc2luY2VMYXN0ID4gNjAgc2Vjb25kcyA8LSB0aGlzIGlzIGNydWNpYWwgZm9yIGtub3dpbmcgaWYgaXQgaXMgYXdheVxuLy8gICAgICAgICAgIGlmKHNpbmNlTGFzdCA+IDYwMDAwKXtcbi8vICAgICAgICAgICAgICAgLy8gaWYgZHVyYXRpb24gID4gMSBtaW51dGUgdGhlbiBzZW5kIHZpc2l0XG4vLyAgICAgICAgICAgICAgIGlmKCBkdXJhdGlvbiA+IDYwMDAwKXtcbi8vICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU2VuZGluZyB2aXNpdCBiOiBcIit2aXNpdFswXSlcbi8vICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQWN0dWFsIGltcGxlbWVudGF0aW9uIHBlbmRpbmcuLlwiKTtcbi8vICAgICAgICAgICAgICAgICAgIHJlcGx5ID0gdHJ1ZVxuLy8gICAgICAgICAgICAgICB9XG4vLyAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRGVsZXRpbmcgdmlzaXQgZHVlIHRvIG1vcmUgdGhhbiAxIG1pbnV0ZSBhd2F5OiBcIit2aXNpdFswXSk7XG4vLyAgICAgICAgICAgICAgIHRoaXMuZGVsZXRlVmlzaXQodmlzaXRbMF0pO1xuLy8gICAgICAgICAgIH1cbi8vICAgICAgICAgICB9KTtcbi8vICAgICAgIH1cblxuLy8gICAgICAgcmV0dXJuIHJlcGx5O1xuLy8gfVxuXG59Il19